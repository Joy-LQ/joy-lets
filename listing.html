<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=375px, initial-scale=1.0">
  <title>Property ¬∑ Joy Lets</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .photo-slider {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    .photo-slider-track {
      display: flex;
      height: 100%;
      transition: transform 0.3s ease;
    }
    .photo-slider-track img {
      min-width: 100%;
      height: 100%;
      object-fit: cover;
      flex-shrink: 0;
    }
    .photo-dots {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 6px;
    }
    .photo-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      transition: background 0.2s;
    }
    .photo-dot.active { background: white; }
    .photo-count {
      position: absolute;
      bottom: 12px;
      right: 16px;
      background: rgba(0,0,0,0.45);
      color: white;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 12px;
    }
  </style>
</head>
<body>
<div class="app">

  <!-- Photo -->
  <div class="detail-photos">
    <div class="detail-photo-placeholder" id="detail-photo">üè†</div>
    <button class="detail-back" onclick="history.back()">‚Üê</button>
  </div>

  <!-- Content -->
  <div class="detail-content">
    <div class="detail-title" id="detail-title">‚Äî</div>
    <div class="detail-type" id="detail-type">‚Äî</div>
    <div class="detail-rating">
      ‚≠ê <span id="detail-rating">‚Äî</span>
      <span style="color:var(--neutral-70)" id="detail-reviews"></span>
    </div>

    <hr class="detail-divider">

    <div class="detail-section-title">About this property</div>
    <div style="font-size:14px;color:var(--neutral-70);line-height:22px" id="detail-desc">‚Äî</div>

    <hr class="detail-divider">

    <div class="detail-section-title">Rent</div>
    <div class="detail-price-row">
      <div class="detail-price" id="detail-price">‚Äî</div>
      <div class="detail-price-unit">/month</div>
    </div>
    <div style="font-size:13px;color:var(--neutral-70);margin-top:4px" id="detail-weekly"></div>
    <div style="font-size:13px;color:var(--neutral-70);margin-top:2px">Bills not included</div>

    <hr class="detail-divider">

    <div class="detail-section-title">Available from</div>
    <div style="font-size:14px;color:var(--neutral-100)" id="detail-avail">‚Äî</div>

    <hr class="detail-divider">

    <div class="detail-section-title">Amenities</div>
    <div class="amenity-list" id="detail-amenities"></div>

    <hr class="detail-divider">

    <div class="detail-section-title">Tenancy</div>
    <div style="font-size:14px;color:var(--neutral-70);line-height:22px">
      Available as 10-month or 12-month Assured Shorthold Tenancy.<br>
      All viewings arranged via Joy Lets.
    </div>
  </div>

  <!-- Enquire bar -->
  <div class="enquire-bar">
    <div>
      <div class="enquire-price">¬£<span id="bar-price">‚Äî</span> <span>/mo</span></div>
    </div>
    <button class="enquire-btn" onclick="openJoyChat()">Enquire Now</button>
  </div>

</div>

<!-- Enquiry Modal -->
<div class="modal-overlay" id="modal" onclick="closeIfOutside(event)">
  <div class="modal">
    <div class="modal-title">Send an Enquiry</div>
    <input type="text" placeholder="Your name" id="enq-name">
    <input type="tel" placeholder="Phone number" id="enq-phone">
    <input type="email" placeholder="Email address" id="enq-email">
    <textarea placeholder="Any questions or preferred viewing times?" id="enq-msg"></textarea>
    <button class="modal-submit" onclick="submitEnquiry()">Send Message</button>
  </div>
</div>

<script src="js/app.js"></script>
<script src="js/contact.js"></script>
<script>window.JOY_CHAT_CONFIG = { apiUrl: "https://chat.man-live.uk" }</script>
<script src="js/chat-widget.js"></script>
<script>
  const id = new URLSearchParams(location.search).get('id');
  fetch('data/listings.json')
    .then(r => r.json())
    .then(data => {
      const local = JSON.parse(localStorage.getItem('listings') || '[]');
      const localIds = new Set(local.map(l => l.id));
      const all = [...local, ...data.listings.filter(l => !localIds.has(l.id))];
      const listing = all.find(l => l.id === id);
      if (!listing) return;
      document.title = listing.title + ' ¬∑ Joy Lets';

      // Photo slider
      const photoContainer = document.getElementById('detail-photo').parentElement;
      if (listing.photos && listing.photos.length > 0) {
        const photos = listing.photos;
        let current = 0;

        const sliderHTML = `
          <div class="photo-slider" id="photo-slider">
            <div class="photo-slider-track" id="slider-track">
              ${photos.map(p => `<img src="${p}" alt="${listing.title}">`).join('')}
            </div>
            ${photos.length > 1 ? `
              <div class="photo-dots">
                ${photos.map((_, i) => `<div class="photo-dot ${i === 0 ? 'active' : ''}"></div>`).join('')}
              </div>
              <div class="photo-count">1 / ${photos.length}</div>
            ` : ''}
          </div>
        `;
        document.getElementById('detail-photo').outerHTML = sliderHTML;

        if (photos.length > 1) {
          const slider = document.getElementById('photo-slider');
          const track = document.getElementById('slider-track');
          const dots = document.querySelectorAll('.photo-dot');
          const countEl = document.querySelector('.photo-count');

          function goTo(idx) {
            current = idx;
            track.style.transform = `translateX(-${idx * 100}%)`;
            dots.forEach((d, i) => d.classList.toggle('active', i === idx));
            countEl.textContent = `${idx + 1} / ${photos.length}`;
          }

          // Touch swipe
          let startX = 0;
          slider.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
          slider.addEventListener('touchend', e => {
            const diff = startX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 40) {
              if (diff > 0 && current < photos.length - 1) goTo(current + 1);
              else if (diff < 0 && current > 0) goTo(current - 1);
            }
          });
        }
      }

      document.getElementById('detail-title').textContent = listing.title;
      document.getElementById('detail-type').textContent = listing.type + (listing.furnished ? ' ¬∑ Furnished' : '');
      document.getElementById('detail-rating').textContent = listing.rating;
      document.getElementById('detail-reviews').textContent = '(' + listing.reviews + ' reviews)';
      document.getElementById('detail-desc').textContent = listing.description + ' ‚Äî a well-presented property in Manchester, ideal for professionals or students.';
      document.getElementById('detail-price').textContent = '¬£' + listing.price.toLocaleString();
      document.getElementById('bar-price').textContent = listing.price.toLocaleString();

      // Weekly per-person price
      const tenants = listing.maxTenants || 1;
      const weeklyPP = Math.round(listing.price * 12 / 52 / tenants);
      document.getElementById('detail-weekly').textContent = `¬£${weeklyPP} per person per week`;

      document.getElementById('detail-avail').textContent =
        new Date(listing.available).toLocaleDateString('en-GB', {day:'numeric', month:'long', year:'numeric'});
      const amenDiv = document.getElementById('detail-amenities');
      listing.amenities.forEach(a => {
        const tag = document.createElement('div');
        tag.className = 'amenity-tag';
        tag.textContent = a;
        amenDiv.appendChild(tag);
      });
    });

  function openEnquiry() {
    document.getElementById('modal').classList.add('open');
  }
  function closeIfOutside(e) {
    if (e.target === document.getElementById('modal'))
      document.getElementById('modal').classList.remove('open');
  }
  function submitEnquiry() {
    const name = document.getElementById('enq-name').value;
    if (!name) { alert('Please enter your name'); return; }
    document.getElementById('modal').classList.remove('open');
    alert('Thank you ' + name + '! We\'ll be in touch shortly.');
  }
</script>
</body>
</html>
